/*
========================================================
                ุญู ูุดููุฉ ุนููุฏ ุงููุฆุฉ ุงูููููุฏ
========================================================

ุงููุดููุฉ: Could not find the 'category' column of 'products'
ุงูุญู: ุฅุถุงูุฉ ุงูุนููุฏ ุงูููููุฏ ูุชุญุฏูุซ ุงูุจูุงูุงุช

ููููุฉ ุงูุงุณุชุฎุฏุงู:
1. ุงูุชูู ุฅูู Supabase Dashboard
2. ุงุถุบุท "SQL Editor"
3. ุงูุณุฎ ูุงูุตู ูุงูู ูุญุชูู ูุฐุง ุงูููู
4. ุงุถุบุท "Run"
5. ุฃุนุฏ ุชุญููู ุตูุญุฉ ุงููุฎุฒูู

========================================================
*/

-- ุฅุถุงูุฉ ุนููุฏ ุงููุฆุฉ ุฅุฐุง ูู ููู ููุฌูุฏ
ALTER TABLE products 
ADD COLUMN IF NOT EXISTS category TEXT;

-- ุชุญุฏูุซ ุงูููุชุฌุงุช ุงูููุฌูุฏ๏ฟฝ๏ฟฝ ุจูุฆุงุช ุฐููุฉ
UPDATE products 
SET category = CASE 
    -- ููููุงุช ุบุฐุงุฆูุฉ
    WHEN LOWER(name) LIKE '%ุจุฑูุชูู%' OR 
         LOWER(name) LIKE '%ูุฑูุงุชูู%' OR 
         LOWER(name) LIKE '%ููุชุงููู%' OR 
         LOWER(name) LIKE '%ุฃุญูุงุถ%' OR
         LOWER(name) LIKE '%ูููู%' 
    THEN 'ููููุงุช'
    
    -- ูุดุฑูุจุงุช
    WHEN LOWER(name) LIKE '%ูุดุฑูุจ%' OR 
         LOWER(name) LIKE '%ุทุงูุฉ%' OR 
         LOWER(name) LIKE '%ุนุตูุฑ%'
    THEN 'ูุดุฑูุจุงุช'
    
    -- ุฃุฏูุงุช ุฑูุงุถูุฉ
    WHEN LOWER(name) LIKE '%ุดููุฑ%' OR 
         LOWER(name) LIKE '%ุญุฒุงู%' OR 
         LOWER(name) LIKE '%ููุงุฒ%' OR
         LOWER(name) LIKE '%ุฃุฏูุงุช%'
    THEN 'ุฃุฏูุงุช'
    
    -- ุฅูุณุณูุงุฑุงุช
    WHEN LOWER(name) LIKE '%ููุดูุฉ%' OR 
         LOWER(name) LIKE '%ุญููุจุฉ%' OR
         LOWER(name) LIKE '%ุฅูุณุณูุงุฑ%'
    THEN 'ุฅูุณุณูุงุฑุงุช'
    
    -- ููุงุจุณ ุฑูุงุถูุฉ
    WHEN LOWER(name) LIKE '%ูููุต%' OR 
         LOWER(name) LIKE '%ุดูุฑุช%' OR 
         LOWER(name) LIKE '%ููุงุจุณ%'
    THEN 'ููุงุจุณ'
    
    -- ูุฆุฉ ุงูุชุฑุงุถูุฉ
    ELSE 'ุฃุฎุฑู'
END
WHERE category IS NULL;

-- ุฅุถุงูุฉ ููุฑุณ ูุชุญุณูู ุงูุฃุฏุงุก
CREATE INDEX IF NOT EXISTS idx_products_category ON products(category);

-- ุฅุถุงูุฉ ููุฑุณ ุฅุถุงูู ููุจุญุซ
CREATE INDEX IF NOT EXISTS idx_products_name_category ON products(name, category);

-- ุฅุฏุฑุงุฌ ููุชุฌุงุช ุชุฌุฑูุจูุฉ ุฅุถุงููุฉ (ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ)
INSERT INTO products (name, quantity, price, description, category) 
VALUES 
    ('ุจุฑูุชูู ูุงู', 15, 280.00, 'ุจุฑูุชูู ูุตู ุงููุจู ุงููุนุฒูู', 'ููููุงุช'),
    ('ูุฑูุงุชูู ููููููุฏุฑุงุช', 20, 150.00, 'ูุฑูุงุชูู ุฎุงูุต 100%', 'ููููุงุช'),
    ('ูุดุฑูุจ ุทุงูุฉ ุฑูุฏ ุจูู', 50, 8.00, 'ูุดุฑูุจ ุทุงูุฉ ุณุฑูุน ุงูููุนูู', 'ูุดุฑูุจุงุช'),
    ('ููุงุฒุงุช ุฌูู', 10, 65.00, 'ููุงุฒุงุช ุฑูุงุถูุฉ ูุถุงุฏุฉ ููุงูุฒูุงู', 'ุฃุฏูุงุช'),
    ('ุญุฒุงู ุฑูุน ุฃุซูุงู ุฌูุฏู', 8, 350.00, 'ุญุฒุงู ุฏุนู ุธูุฑ ุฌูุฏ ุทุจูุนู', 'ุฃุฏูุงุช')
ON CONFLICT (name) DO NOTHING;

-- ุงูุชุญูู ูู ุงู๏ฟฝ๏ฟฝุชุงุฆุฌ
SELECT 
    '๐ฏ ูุชุงุฆุฌ ุงูุฅุตูุงุญ:' as status,
    COUNT(*) as total_products,
    COUNT(CASE WHEN category IS NOT NULL THEN 1 END) as products_with_category,
    ROUND(
        (COUNT(CASE WHEN category IS NOT NULL THEN 1 END) * 100.0 / COUNT(*)), 
        1
    ) || '%' as completion_percentage
FROM products;

-- ุนุฑุถ ุงููุฆุงุช ุงูููุฌูุฏุฉ
SELECT 
    '๐ ุงููุฆุงุช ุงููุชุงุญุฉ:' as info,
    category as category_name,
    COUNT(*) as product_count,
    STRING_AGG(name, ', ') as sample_products
FROM products 
WHERE category IS NOT NULL
GROUP BY category
ORDER BY product_count DESC;

-- ุฑุณุงูุฉ ูุฌุงุญ
SELECT 'โ ุชู ุฅุตูุงุญ ูุดููุฉ ุนููุฏ ุงููุฆุฉ ุจูุฌุงุญ! ููููู ุงูุขู ุงุณุชุฎุฏุงู ุตูุญุฉ ุงููุฎุฒูู ุจุฏูู ูุดุงูู.' as success_message;

/*
========================================================
                    ุชู ุงูุงูุชูุงุก!
========================================================

ูุง ุชู ุฅูุฌุงุฒู:
โ ุฅุถุงูุฉ ุนููุฏ category ููุฌุฏูู
โ ุชุตููู ุงูููุชุฌุงุช ุงูููุฌูุฏุฉ ุชููุงุฆูุงู
โ ุฅุถุงูุฉ ููุงุฑุณ ูุชุญุณูู ุงูุฃุฏุงุก
โ ุฅุถุงูุฉ ููุชุฌุงุช ุชุฌุฑูุจูุฉ ุฌุฏูุฏุฉ

ุงูุฎุทูุงุช ุงูุชุงููุฉ:
1. ุฃุนุฏ ุชุญููู ุตูุญุฉ ุงููุฎุฒูู (F5)
2. ุฌุฑุจ ุฅุถุง๏ฟฝ๏ฟฝุฉ ููุชุฌ ุฌุฏูุฏ
3. ุงุฎุชุฑ ูุฆุฉ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ

ุงููุฆุงุช ุงููุชุงุญุฉ:
โข ููููุงุช
โข ูุดุฑูุจุงุช
โข ุฃุฏูุงุช
โข ุฅูุณุณูุงุฑุงุช
โข ููุงุจุณ
โข ุฃุฎุฑู

========================================================
*/
